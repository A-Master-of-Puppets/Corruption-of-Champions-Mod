<project name="Flex Ant Tasks Build Script" default="test">

 <!-- Create a environment variable FLEX_HOME that points to the flex SDK -->
 <property environment="env" />
 <property name="FLEX_HOME" location="${env.FLEX_HOME}" />
 
 <property name="main.src.dir" value="${basedir}/classes"/>
 <property name="test.src.dir" value="${basedir}/test"/>
 <property name="lib.dir" value="${basedir}/lib/bin"/>
 <property name="build.dir" value="${basedir}/target"/>
 <property name="report.dir" value="${build.dir}/report"/>
 <property name="test.file" value="${build.dir}/CoC-test.swf"/>
 
	<!-- Setup Flex and FlexUnit ant tasks -->
	<!-- You can set this directly so mxmlc will work correctly, or set FLEX_HOME as an environment variable and use as below -->
	<taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />
	<taskdef resource="flexUnitTasks.tasks">
	   <classpath>
	      <fileset dir="${lib.dir}/flexunit">
	         <include name="flexUnitTasks*.jar" />
	      </fileset>
	   </classpath>
	</taskdef>
               
   <!-- delete and create the DEPLOY dir again -->
   <target name="init">
      <delete dir="${build.dir}" />
      <mkdir dir="${build.dir}" />
	  <mkdir dir="${report.dir}" />       
   </target>
                              
   <!-- build the swf-->
   <target name="build" depends="init" description="build the project">
      <mxmlc file="${main.src.dir}/classes/CoC.as" output="${build.dir}/CoC.swf" static-rsls="true">
         <load-config filename="${FLEX_HOME}/frameworks/flex-config.xml"/>
         <source-path path-element="${FLEX_HOME}/frameworks"/>
		 <source-path path-element="${main.src.dir}/"/>
         <compiler.debug>true</compiler.debug>
        <library-path dir="${lib.dir}" includes="*.swc" append="true"/>
		<define name="CONFIG::release" value="false"/>
		<define name="CONFIG::debug" value="true"/>
		<define name="CONFIG::AIR" value="false"/>
		<define name="CONFIG::STANDALONE" value="true"/>
      </mxmlc>
   </target>
   
   <!-- build the swf for tests -->
   <target name="build-test" depends="init" description="build the project">
      <mxmlc file="${test.src.dir}/TestRunner.mxml" output="${test.file}" static-rsls="true">
         <load-config filename="${FLEX_HOME}/frameworks/flex-config.xml"/>
         <source-path path-element="${FLEX_HOME}/frameworks"/>
		 <source-path path-element="${main.src.dir}/"/>
		 <source-path path-element="${test.src.dir}"/>
		
        <compiler.debug>true</compiler.debug>
        <library-path dir="${lib.dir}" includes="*.swc" append="true"/>
		<library-path dir="${lib.dir}/flexunit" includes="*.swc" append="true"/>
		<define name="CONFIG::release" value="false"/>
		<define name="CONFIG::debug" value="true"/>
		<define name="CONFIG::AIR" value="false"/>
		<define name="CONFIG::STANDALONE" value="true"/>
      </mxmlc>
   </target>
   
   	<target name="test" depends="build-test">
		<!-- Execute FlexUnit tests and publish reports -->
		<flexunit 
		    workingDir="${build.dir}"
		    toDir="${report.dir}" 
			haltonfailure="false" 
			verbose="true"
			swf="${test.file}"
			localTrusted="true">
	      <source dir="${main.src.dir}/" />
	      <library dir="${lib.dir}" />
	   </flexunit>

		<!-- Generate readable JUnit-style reports -->
		<junitreport todir="${report.dir}">
			<fileset dir="${report.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${report.dir}/html" />
		</junitreport>
	</target>
</project>